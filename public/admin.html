<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Manage Raffle Items</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="header-content">
            <img src="/c4c-logo.png" alt="Carve 4 Cancer Logo" class="header-logo">
            <div class="header-text">
                <h1>Admin - Manage Raffle Items</h1>
                <p><a href="/index.html">Back to Raffle Display</a></p>
            </div>
        </div>
    </header>

    <main>
        <div class="form-container">
            <div id="login-form" class="auth-form">
                <h2>Admin Login</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="login-username">Username:</label>
                        <input type="text" id="login-username" value="admin" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password:</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <button type="submit" class="btn-primary">Login</button>
                </form>
                <div id="login-error" class="error-message"></div>
            </div>

            <div id="raffle-form" class="content-form" style="display: none;">
                <h2>Add New Raffle Item</h2>
                <form id="addRaffleForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="raffle-name">Raffle Item Name: *</label>
                        <input type="text" id="raffle-name" required>
                    </div>

                    <div class="form-group">
                        <label for="raffle-description">Description: *</label>
                        <textarea id="raffle-description" rows="4" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="raffle-donated-by">Donated By:</label>
                        <input type="text" id="raffle-donated-by" placeholder="Enter donor name (optional)">
                    </div>

                    <div class="form-group">
                        <label>Upload Picture: *</label>
                        <div class="image-upload-tabs">
                            <button type="button" class="tab-btn active" onclick="switchUploadTab('file')">Upload from File</button>
                            <button type="button" class="tab-btn" onclick="switchUploadTab('url')">Add from URL</button>
                        </div>
                        <div id="file-upload-section" class="upload-section">
                            <input type="file" id="raffle-image" accept="image/*">
                            <p class="hint">On mobile: Tap to choose from photos or take a new picture</p>
                        </div>
                        <div id="url-upload-section" class="upload-section" style="display: none;">
                            <input type="text" id="raffle-image-url" placeholder="Paste image URL (e.g., from Google Images)">
                            <p class="hint"><strong>Tip:</strong> In Google Images, click the image to open it, then right-click the full-size image and select "Open image in new tab". Copy that URL. (Some Google cached URLs may not work - if it fails, try uploading from file instead.)</p>
                        </div>
                        <div id="image-preview"></div>
                    </div>

                    <button type="submit" class="btn-primary">Add Raffle Item</button>
                    <button type="button" class="btn-secondary" onclick="logout()">Logout</button>
                </form>
                <div id="form-message"></div>
            </div>
        </div>

        <div id="raffle-list" style="display: none;">
            <h2>Current Raffle Items</h2>
            <div class="admin-search-container">
                <input
                    type="text"
                    id="admin-search-input"
                    placeholder="Search raffle items by name, description, or number..."
                    autocomplete="off"
                >
                <span id="admin-search-count"></span>
            </div>
            <div class="export-controls">
                <div class="export-buttons">
                    <button id="export-all-btn" class="btn-primary" onclick="exportAllToPDF()">
                        Export All to PDF
                    </button>
                    <button id="export-selected-btn" class="btn-secondary" onclick="exportSelectedToPDF()" disabled>
                        Export Selected (0)
                    </button>
                </div>
            </div>
            <div id="raffles-list-container"></div>
        </div>

        <div id="rules-editor" style="display: none;">
            <h2>Edit Raffle Rules & Information</h2>
            <form id="editRulesForm">
                <div class="form-group">
                    <label for="rules-textarea">Rules Text:</label>
                    <textarea id="rules-textarea" rows="10" required></textarea>
                    <p class="hint">Use line breaks to separate lines. This will be displayed on the main raffle page.</p>
                </div>
                <button type="submit" class="btn-primary">Update Rules</button>
            </form>
            <div id="rules-form-message"></div>
        </div>

        <div id="sponsors-manager" style="display: none;">
            <h2>Manage Sponsors</h2>
            <form id="addSponsorForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="sponsor-name">Sponsor Name: *</label>
                    <input type="text" id="sponsor-name" required>
                </div>
                <div class="form-group">
                    <label for="sponsor-website">Website URL (optional):</label>
                    <input type="text" id="sponsor-website" placeholder="https://example.com">
                </div>
                <div class="form-group">
                    <label for="sponsor-logo">Logo Image: *</label>
                    <input type="file" id="sponsor-logo" accept="image/*" required>
                    <p class="hint">Recommended: PNG or SVG with transparent background</p>
                </div>
                <div id="sponsor-logo-preview"></div>
                <button type="submit" class="btn-primary">Add Sponsor</button>
            </form>
            <div id="sponsor-form-message"></div>

            <h3 style="margin-top: 2rem;">Current Sponsors</h3>
            <div id="sponsors-list-container"></div>
        </div>
    </main>

    <div id="edit-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>Edit Raffle Item</h2>
            <form id="editRaffleForm" enctype="multipart/form-data">
                <input type="hidden" id="edit-raffle-id">
                <div class="form-group">
                    <label for="edit-raffle-name">Raffle Item Name: *</label>
                    <input type="text" id="edit-raffle-name" required>
                </div>

                <div class="form-group">
                    <label for="edit-raffle-description">Description: *</label>
                    <textarea id="edit-raffle-description" rows="4" required></textarea>
                </div>

                <div class="form-group">
                    <label for="edit-raffle-donated-by">Donated By:</label>
                    <input type="text" id="edit-raffle-donated-by" placeholder="Enter donor name (optional)">
                </div>

                <div class="form-group">
                    <label>Change Picture (optional):</label>
                    <div class="image-upload-tabs">
                        <button type="button" class="tab-btn active" onclick="switchEditUploadTab('file')">Upload from File</button>
                        <button type="button" class="tab-btn" onclick="switchEditUploadTab('url')">Add from URL</button>
                    </div>
                    <div id="edit-file-upload-section" class="upload-section">
                        <input type="file" id="edit-raffle-image" accept="image/*">
                        <p class="hint">On mobile: Tap to choose from photos or take a new picture</p>
                    </div>
                    <div id="edit-url-upload-section" class="upload-section" style="display: none;">
                        <input type="text" id="edit-raffle-image-url" placeholder="Paste image URL (e.g., from Google Images)">
                        <p class="hint"><strong>Tip:</strong> In Google Images, click the image to open it, then right-click the full-size image and select "Open image in new tab". Copy that URL. (Some Google cached URLs may not work - if it fails, try uploading from file instead.)</p>
                    </div>
                    <div id="edit-image-preview"></div>
                </div>

                <button type="submit" class="btn-primary">Update Raffle Item</button>
                <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
            </form>
            <div id="edit-form-message"></div>
        </div>
    </div>

    <script>
        let currentCredentials = null;
        let currentUploadMode = 'file'; // 'file' or 'url'
        let currentEditUploadMode = 'file';

        function switchUploadTab(mode) {
            currentUploadMode = mode;
            const fileTabs = document.querySelectorAll('#raffle-form .tab-btn');
            const fileSection = document.getElementById('file-upload-section');
            const urlSection = document.getElementById('url-upload-section');
            const fileInput = document.getElementById('raffle-image');
            const urlInput = document.getElementById('raffle-image-url');

            fileTabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            if (mode === 'file') {
                fileSection.style.display = 'block';
                urlSection.style.display = 'none';
                fileInput.required = true;
                urlInput.required = false;
                urlInput.value = '';
            } else {
                fileSection.style.display = 'none';
                urlSection.style.display = 'block';
                fileInput.required = false;
                urlInput.required = true;
                fileInput.value = '';
            }
            document.getElementById('image-preview').innerHTML = '';
        }

        function switchEditUploadTab(mode) {
            currentEditUploadMode = mode;
            const editTabs = document.querySelectorAll('#edit-modal .tab-btn');
            const fileSection = document.getElementById('edit-file-upload-section');
            const urlSection = document.getElementById('edit-url-upload-section');
            const fileInput = document.getElementById('edit-raffle-image');
            const urlInput = document.getElementById('edit-raffle-image-url');

            editTabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            if (mode === 'file') {
                fileSection.style.display = 'block';
                urlSection.style.display = 'none';
                urlInput.value = '';
            } else {
                fileSection.style.display = 'none';
                urlSection.style.display = 'block';
                fileInput.value = '';
            }
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (result.success && result.role === 'admin') {
                    currentCredentials = { username, password };
                    document.getElementById('login-form').style.display = 'none';
                    document.getElementById('raffle-form').style.display = 'block';
                    document.getElementById('raffle-list').style.display = 'block';
                    document.getElementById('rules-editor').style.display = 'block';
                    document.getElementById('sponsors-manager').style.display = 'block';
                    loadRaffles();
                    loadRules();
                    loadSponsors();
                } else {
                    document.getElementById('login-error').textContent =
                        'Invalid credentials or not an admin account';
                }
            } catch (error) {
                document.getElementById('login-error').textContent = 'Login error. Please try again.';
            }
        });

        document.getElementById('raffle-image').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const preview = document.getElementById('image-preview');

            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 300px; margin-top: 10px;">`;
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = '';
            }
        });

        document.getElementById('raffle-image-url').addEventListener('input', (e) => {
            const url = e.target.value.trim();
            const preview = document.getElementById('image-preview');

            if (url) {
                preview.innerHTML = `<img src="${url}" alt="Preview" style="max-width: 300px; margin-top: 10px;" onerror="this.parentElement.innerHTML='<p class=\\'error-message\\'>Invalid image URL</p>'">`;
            } else {
                preview.innerHTML = '';
            }
        });

        document.getElementById('addRaffleForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;

            // Disable button to prevent double-clicks
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';

            const formData = new FormData();
            formData.append('username', currentCredentials.username);
            formData.append('password', currentCredentials.password);
            formData.append('name', document.getElementById('raffle-name').value);
            formData.append('description', document.getElementById('raffle-description').value);
            formData.append('donatedBy', document.getElementById('raffle-donated-by').value);

            if (currentUploadMode === 'file') {
                const fileInput = document.getElementById('raffle-image').files[0];
                if (!fileInput) {
                    document.getElementById('form-message').innerHTML =
                        '<div class="error-message">Please select an image file</div>';
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
                formData.append('image', fileInput);
            } else {
                const imageUrl = document.getElementById('raffle-image-url').value.trim();
                if (!imageUrl) {
                    document.getElementById('form-message').innerHTML =
                        '<div class="error-message">Please enter an image URL</div>';
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
                formData.append('imageUrl', imageUrl);
            }

            try {
                const response = await fetch('/api/raffles', {
                    method: 'POST',
                    body: formData
                });

                let result;
                try {
                    result = await response.json();
                } catch (jsonError) {
                    console.error('Failed to parse response:', jsonError);
                    throw new Error('Invalid server response');
                }

                if (result.success) {
                    document.getElementById('form-message').innerHTML =
                        '<div class="success-message">Raffle item added successfully!</div>';
                    document.getElementById('addRaffleForm').reset();
                    document.getElementById('image-preview').innerHTML = '';
                    loadRaffles();

                    setTimeout(() => {
                        document.getElementById('form-message').innerHTML = '';
                    }, 3000);
                } else {
                    document.getElementById('form-message').innerHTML =
                        `<div class="error-message">Error: ${result.message}</div>`;
                }
            } catch (error) {
                console.error('Error adding raffle:', error);
                document.getElementById('form-message').innerHTML =
                    `<div class="error-message">Error: ${error.message || 'Error adding raffle item. Please try again.'}</div>`;
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        let allAdminRaffles = [];

        async function loadRaffles() {
            try {
                const response = await fetch('/api/raffles');
                allAdminRaffles = await response.json();

                displayAdminRaffles(allAdminRaffles);
            } catch (error) {
                console.error('Error loading raffles:', error);
            }
        }

        function displayAdminRaffles(raffles) {
            const container = document.getElementById('raffles-list-container');
            const searchCount = document.getElementById('admin-search-count');

            if (raffles.length === 0) {
                container.innerHTML = '<p>No raffle items yet.</p>';
                searchCount.textContent = '';
                return;
            }

            const searchTerm = document.getElementById('admin-search-input').value;
            if (searchTerm && raffles.length < allAdminRaffles.length) {
                searchCount.textContent = `Showing ${raffles.length} of ${allAdminRaffles.length} items`;
            } else {
                searchCount.textContent = '';
            }

                const isFiltered = raffles.length < allAdminRaffles.length;

                container.innerHTML = `
                    ${isFiltered ? '<div class="reorder-instructions" style="background: #fff3cd; border-left: 4px solid #ffc107;"><p><strong>‚ö†Ô∏è Note:</strong> Clear search to reorder items (drag & drop disabled while filtering)</p></div>' : '<div class="reorder-instructions"><p><strong>üí° Tip:</strong> Drag and drop rows to reorder raffle items</p></div>'}
                    <table class="raffle-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="header-select-all" onchange="toggleSelectAll()" title="Select all"></th>
                                <th style="width: 40px;">#</th>
                                <th style="width: 50px;">Drag</th>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Winning Number</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="raffle-table-body">
                            ${raffles.map(raffle => `
                                <tr draggable="${!isFiltered}" data-raffle-id="${raffle.id}">
                                    <td><input type="checkbox" class="raffle-select" data-raffle-id="${raffle.id}" onchange="updateExportButton()"></td>
                                    <td><strong>#${raffle.number || '?'}</strong></td>
                                    <td class="drag-handle">‚ãÆ‚ãÆ</td>
                                    <td><img src="${raffle.image}" alt="${raffle.name}" style="max-width: 80px;"></td>
                                    <td>${raffle.name}</td>
                                    <td>${raffle.description}</td>
                                    <td>
                                        <div class="winner-update-cell">
                                            <input
                                                type="tel"
                                                inputmode="numeric"
                                                pattern="[0-9]*"
                                                id="winner-${raffle.id}"
                                                value="${raffle.winningNumber || ''}"
                                                placeholder="Enter number"
                                                class="winner-input"
                                            >
                                            <button class="btn-action btn-winner" onclick="updateWinner(${raffle.id})">
                                                ${raffle.winningNumber ? 'Update' : 'Set'} Winner
                                            </button>
                                        </div>
                                        <div id="winner-message-${raffle.id}" class="winner-message"></div>
                                    </td>
                                    <td>
                                        <button class="btn-action btn-edit" onclick='editRaffle(${JSON.stringify(raffle)})'>Edit</button>
                                        <button class="btn-action btn-delete" onclick="deleteRaffle(${raffle.id}, '${raffle.name}')">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

            // Initialize drag and drop
            initializeDragAndDrop();
        }

        function searchAdminRaffles() {
            const searchTerm = document.getElementById('admin-search-input').value.toLowerCase();

            if (!searchTerm) {
                displayAdminRaffles(allAdminRaffles);
                return;
            }

            const filtered = allAdminRaffles.filter(raffle => {
                const nameMatch = raffle.name.toLowerCase().includes(searchTerm);
                const descriptionMatch = raffle.description.toLowerCase().includes(searchTerm);
                const numberMatch = raffle.number && raffle.number.toString().includes(searchTerm);
                const winnerMatch = raffle.winningNumber && raffle.winningNumber.toLowerCase().includes(searchTerm);
                return nameMatch || descriptionMatch || numberMatch || winnerMatch;
            });

            displayAdminRaffles(filtered);
        }

        document.getElementById('admin-search-input').addEventListener('input', searchAdminRaffles);

        let draggedRow = null;

        function initializeDragAndDrop() {
            const tbody = document.getElementById('raffle-table-body');
            if (!tbody) return;

            // Only attach drag handlers to rows that are actually draggable
            const rows = tbody.querySelectorAll('tr[draggable="true"]');

            if (rows.length === 0) {
                // Drag and drop is disabled (search is active)
                return;
            }

            rows.forEach(row => {
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragend', handleDragEnd);
                row.addEventListener('dragenter', handleDragEnter);
                row.addEventListener('dragleave', handleDragLeave);
            });
        }

        function handleDragStart(e) {
            draggedRow = this;
            this.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (this !== draggedRow) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedRow !== this) {
                const tbody = this.parentNode;
                const allRows = Array.from(tbody.querySelectorAll('tr[draggable="true"]'));
                const draggedIndex = allRows.indexOf(draggedRow);
                const targetIndex = allRows.indexOf(this);

                if (draggedIndex < targetIndex) {
                    tbody.insertBefore(draggedRow, this.nextSibling);
                } else {
                    tbody.insertBefore(draggedRow, this);
                }

                // Save the new order
                saveRaffleOrder();
            }

            this.classList.remove('drag-over');
            return false;
        }

        function handleDragEnd(e) {
            this.style.opacity = '1';

            const rows = document.querySelectorAll('#raffle-table-body tr[draggable="true"]');
            rows.forEach(row => {
                row.classList.remove('drag-over');
            });
        }

        async function saveRaffleOrder() {
            const tbody = document.getElementById('raffle-table-body');
            const rows = tbody.querySelectorAll('tr[draggable="true"]');
            const orderedIds = Array.from(rows).map(row => parseInt(row.dataset.raffleId));

            try {
                const response = await fetch('/api/raffles/reorder', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentCredentials.username,
                        password: currentCredentials.password,
                        orderedIds
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Reload to show updated numbers
                    loadRaffles();
                } else {
                    alert(`Error reordering: ${result.message}`);
                }
            } catch (error) {
                console.error('Error saving order:', error);
                alert('Error saving new order. Please try again.');
            }
        }

        function editRaffle(raffle) {
            document.getElementById('edit-raffle-id').value = raffle.id;
            document.getElementById('edit-raffle-name').value = raffle.name;
            document.getElementById('edit-raffle-description').value = raffle.description;
            document.getElementById('edit-raffle-donated-by').value = raffle.donatedBy || '';
            document.getElementById('edit-image-preview').innerHTML = `
                <p style="margin-top: 10px;">Current image:</p>
                <img src="${raffle.image}" alt="${raffle.name}" style="max-width: 300px;">
            `;
            document.getElementById('edit-modal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            document.getElementById('editRaffleForm').reset();
            document.getElementById('edit-image-preview').innerHTML = '';
            document.getElementById('edit-form-message').innerHTML = '';
        }

        document.getElementById('edit-raffle-image').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const preview = document.getElementById('edit-image-preview');

            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.innerHTML = `
                        <p style="margin-top: 10px;">New image preview:</p>
                        <img src="${e.target.result}" alt="Preview" style="max-width: 300px;">
                    `;
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('edit-raffle-image-url').addEventListener('input', (e) => {
            const url = e.target.value.trim();
            const preview = document.getElementById('edit-image-preview');

            if (url) {
                preview.innerHTML = `
                    <p style="margin-top: 10px;">New image preview:</p>
                    <img src="${url}" alt="Preview" style="max-width: 300px;" onerror="this.parentElement.innerHTML='<p class=\\'error-message\\'>Invalid image URL</p>'">
                `;
            }
        });

        document.getElementById('editRaffleForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const raffleId = document.getElementById('edit-raffle-id').value;
            const formData = new FormData();
            formData.append('username', currentCredentials.username);
            formData.append('password', currentCredentials.password);
            formData.append('name', document.getElementById('edit-raffle-name').value);
            formData.append('description', document.getElementById('edit-raffle-description').value);
            formData.append('donatedBy', document.getElementById('edit-raffle-donated-by').value);

            if (currentEditUploadMode === 'file') {
                const imageFile = document.getElementById('edit-raffle-image').files[0];
                if (imageFile) {
                    formData.append('image', imageFile);
                }
            } else {
                const imageUrl = document.getElementById('edit-raffle-image-url').value.trim();
                if (imageUrl) {
                    formData.append('imageUrl', imageUrl);
                }
            }

            try {
                const response = await fetch(`/api/raffles/${raffleId}`, {
                    method: 'PUT',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('edit-form-message').innerHTML =
                        '<div class="success-message">Raffle item updated successfully!</div>';

                    setTimeout(() => {
                        closeEditModal();
                        loadRaffles();
                    }, 1500);
                } else {
                    document.getElementById('edit-form-message').innerHTML =
                        `<div class="error-message">Error: ${result.message}</div>`;
                }
            } catch (error) {
                document.getElementById('edit-form-message').innerHTML =
                    '<div class="error-message">Error updating raffle item. Please try again.</div>';
            }
        });

        async function deleteRaffle(raffleId, raffleName) {
            if (!confirm(`Are you sure you want to delete "${raffleName}"? This cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/raffles/${raffleId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentCredentials.username,
                        password: currentCredentials.password
                    })
                });

                const result = await response.json();

                if (result.success) {
                    loadRaffles();
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                alert('Error deleting raffle item. Please try again.');
            }
        }

        async function updateWinner(raffleId) {
            const winningNumber = document.getElementById(`winner-${raffleId}`).value.trim();
            const messageDiv = document.getElementById(`winner-message-${raffleId}`);

            try {
                const response = await fetch(`/api/raffles/${raffleId}/winner`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentCredentials.username,
                        password: currentCredentials.password,
                        winningNumber
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const message = winningNumber ? 'Winner updated!' : 'Winner cleared!';
                    messageDiv.innerHTML = `<span class="success-text">${message}</span>`;
                    setTimeout(() => {
                        messageDiv.innerHTML = '';
                        loadRaffles();
                    }, 2000);
                } else {
                    messageDiv.innerHTML = `<span class="error-text">Error: ${result.message}</span>`;
                    setTimeout(() => messageDiv.innerHTML = '', 3000);
                }
            } catch (error) {
                messageDiv.innerHTML = '<span class="error-text">Error updating winner</span>';
                setTimeout(() => messageDiv.innerHTML = '', 3000);
            }
        }

        async function loadRules() {
            try {
                const response = await fetch('/api/rules');
                const data = await response.json();
                document.getElementById('rules-textarea').value = data.rules || '';
            } catch (error) {
                console.error('Error loading rules:', error);
            }
        }

        document.getElementById('editRulesForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const rules = document.getElementById('rules-textarea').value;

            try {
                const response = await fetch('/api/rules', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentCredentials.username,
                        password: currentCredentials.password,
                        rules
                    })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('rules-form-message').innerHTML =
                        '<div class="success-message">Rules updated successfully!</div>';

                    setTimeout(() => {
                        document.getElementById('rules-form-message').innerHTML = '';
                    }, 3000);
                } else {
                    document.getElementById('rules-form-message').innerHTML =
                        `<div class="error-message">Error: ${result.message}</div>`;
                }
            } catch (error) {
                document.getElementById('rules-form-message').innerHTML =
                    '<div class="error-message">Error updating rules. Please try again.</div>';
            }
        });

        function logout() {
            currentCredentials = null;
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('raffle-form').style.display = 'none';
            document.getElementById('raffle-list').style.display = 'none';
            document.getElementById('rules-editor').style.display = 'none';
            document.getElementById('sponsors-manager').style.display = 'none';
            document.getElementById('loginForm').reset();
            document.getElementById('login-error').textContent = '';
        }

        // Sponsor management functions
        async function loadSponsors() {
            try {
                const response = await fetch('/api/sponsors');
                const sponsors = await response.json();
                displaySponsors(sponsors);
            } catch (error) {
                console.error('Error loading sponsors:', error);
            }
        }

        function displaySponsors(sponsors) {
            const container = document.getElementById('sponsors-list-container');

            if (sponsors.length === 0) {
                container.innerHTML = '<p class="no-items">No sponsors added yet.</p>';
                return;
            }

            container.innerHTML = `
                <div class="sponsors-grid">
                    ${sponsors.map(sponsor => `
                        <div class="sponsor-card">
                            <img src="${sponsor.logo}" alt="${sponsor.name}" class="sponsor-logo-preview">
                            <div class="sponsor-info">
                                <strong>${sponsor.name}</strong>
                                ${sponsor.websiteUrl ? `<br><a href="${sponsor.websiteUrl}" target="_blank" class="sponsor-link">${sponsor.websiteUrl}</a>` : ''}
                            </div>
                            <button class="btn-delete" onclick="deleteSponsor(${sponsor.id})">Delete</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        document.getElementById('sponsor-logo').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const preview = document.getElementById('sponsor-logo-preview');

            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 200px; max-height: 100px; margin-top: 10px;">`;
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = '';
            }
        });

        document.getElementById('addSponsorForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('username', currentCredentials.username);
            formData.append('password', currentCredentials.password);
            formData.append('name', document.getElementById('sponsor-name').value);
            formData.append('websiteUrl', document.getElementById('sponsor-website').value);
            formData.append('logo', document.getElementById('sponsor-logo').files[0]);

            try {
                const response = await fetch('/api/sponsors', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('sponsor-form-message').innerHTML =
                        '<div class="success-message">Sponsor added successfully!</div>';
                    document.getElementById('addSponsorForm').reset();
                    document.getElementById('sponsor-logo-preview').innerHTML = '';
                    loadSponsors();

                    setTimeout(() => {
                        document.getElementById('sponsor-form-message').innerHTML = '';
                    }, 3000);
                } else {
                    document.getElementById('sponsor-form-message').innerHTML =
                        `<div class="error-message">Error: ${result.message}</div>`;
                }
            } catch (error) {
                document.getElementById('sponsor-form-message').innerHTML =
                    '<div class="error-message">Error adding sponsor. Please try again.</div>';
            }
        });

        async function deleteSponsor(sponsorId) {
            if (!confirm('Are you sure you want to delete this sponsor?')) return;

            try {
                const response = await fetch(`/api/sponsors/${sponsorId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentCredentials.username,
                        password: currentCredentials.password
                    })
                });

                const result = await response.json();

                if (result.success) {
                    loadSponsors();
                } else {
                    alert('Error deleting sponsor: ' + result.message);
                }
            } catch (error) {
                alert('Error deleting sponsor. Please try again.');
            }
        }

        // ==================== PDF Export Functions ====================

        const PDF_CONFIG = {
            // Page dimensions (8.5" x 11" in points, 72 points per inch)
            pageWidth: 612,
            pageHeight: 792,

            // Card dimensions (quarter page)
            cardWidth: 306,
            cardHeight: 396,

            // Template image dimensions
            templateWidth: 1500,
            templateHeight: 1500,

            // Content area positioning (relative to template, in pixels)
            contentStartY: 620,
            contentPadding: 80,

            // QR code settings
            qrSize: 150,
            qrMargin: 50,

            // QR code URL
            qrUrl: 'https://raffle.carve4cancer.com'
        };

        // Load external libraries dynamically
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                if (document.querySelector(`script[src="${src}"]`)) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function loadPDFLibraries() {
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
        }

        // Generate QR code using free API
        function generateQRCodeUrl() {
            const size = PDF_CONFIG.qrSize;
            const data = encodeURIComponent(PDF_CONFIG.qrUrl);
            return `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${data}&margin=0`;
        }

        // Load QR code image
        function loadQRCodeImage() {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('Failed to load QR code'));
                img.src = generateQRCodeUrl();
            });
        }

        // Load template image
        function loadTemplateImage() {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('Failed to load template image'));
                img.src = '/assets/pdf-template.png';
            });
        }

        // Text wrapping helper
        function wrapText(ctx, text, maxWidth) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';

            words.forEach(word => {
                const testLine = currentLine ? `${currentLine} ${word}` : word;
                const metrics = ctx.measureText(testLine);

                if (metrics.width > maxWidth && currentLine) {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = testLine;
                }
            });

            if (currentLine) {
                lines.push(currentLine);
            }

            return lines;
        }

        // Create single card as canvas
        async function createCardCanvas(raffle, templateImg, qrImg) {
            const canvas = document.createElement('canvas');
            canvas.width = PDF_CONFIG.templateWidth;
            canvas.height = PDF_CONFIG.templateHeight;
            const ctx = canvas.getContext('2d');

            // Draw template background
            ctx.drawImage(templateImg, 0, 0);

            // Set up text rendering
            ctx.textAlign = 'center';
            const centerX = canvas.width / 2;
            let currentY = PDF_CONFIG.contentStartY;

            // Draw Item Number (subtle label)
            ctx.font = 'italic 52px Georgia, serif';
            ctx.fillStyle = '#1a5f7a';
            ctx.fillText(`Item #${raffle.number}`, centerX, currentY);
            currentY += 120;

            // Draw Item Name - DOMINANT headline (bold, no italic)
            ctx.font = 'bold 95px Georgia, serif';
            ctx.fillStyle = '#1a5f7a';
            const maxNameWidth = canvas.width - PDF_CONFIG.contentPadding * 2;
            const nameLines = wrapText(ctx, raffle.name, maxNameWidth);
            const maxNameLines = 2;
            nameLines.slice(0, maxNameLines).forEach((line, i) => {
                if (i === maxNameLines - 1 && nameLines.length > maxNameLines) {
                    line = line.slice(0, -3) + '...';
                }
                ctx.fillText(line, centerX, currentY);
                currentY += 110;
            });
            currentY += 40;

            // Draw Description (readable body text)
            ctx.font = '46px Georgia, serif';
            ctx.fillStyle = '#1a5f7a';
            const maxDescWidth = canvas.width - PDF_CONFIG.contentPadding * 2;
            const descLines = wrapText(ctx, raffle.description, maxDescWidth);
            const maxDescLines = 4;
            descLines.slice(0, maxDescLines).forEach((line, i) => {
                if (i === maxDescLines - 1 && descLines.length > maxDescLines) {
                    line = line.slice(0, -3) + '...';
                }
                ctx.fillText(line, centerX, currentY);
                currentY += 58;
            });

            // Draw Donor info (if present) - prominent donor name
            if (raffle.donatedBy) {
                currentY = canvas.height - PDF_CONFIG.qrMargin - PDF_CONFIG.qrSize - 120;
                ctx.font = '36px Georgia, serif';
                ctx.fillStyle = '#333333';
                ctx.fillText('Donated by', centerX, currentY);
                currentY += 60;
                ctx.font = 'bold 52px Georgia, serif';
                ctx.fillText(raffle.donatedBy, centerX, currentY);
            }

            // Draw QR code in bottom right
            const qrX = canvas.width - PDF_CONFIG.qrMargin - PDF_CONFIG.qrSize;
            const qrY = canvas.height - PDF_CONFIG.qrMargin - PDF_CONFIG.qrSize;

            // Draw white background for QR code
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(qrX - 8, qrY - 8, PDF_CONFIG.qrSize + 16, PDF_CONFIG.qrSize + 16);
            ctx.strokeStyle = '#cccccc';
            ctx.lineWidth = 1;
            ctx.strokeRect(qrX - 8, qrY - 8, PDF_CONFIG.qrSize + 16, PDF_CONFIG.qrSize + 16);

            ctx.drawImage(qrImg, qrX, qrY, PDF_CONFIG.qrSize, PDF_CONFIG.qrSize);

            return canvas;
        }

        // Show loading overlay
        function showLoadingOverlay(total) {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'pdf-loading';
            loadingDiv.innerHTML = `
                <div class="pdf-loading-overlay">
                    <div class="pdf-loading-content">
                        <div class="pdf-spinner"></div>
                        <p>Generating PDF...</p>
                        <p class="pdf-progress">0 / ${total} cards</p>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingDiv);
            return loadingDiv;
        }

        // Update loading progress
        function updateLoadingProgress(current, total) {
            const progressEl = document.querySelector('.pdf-progress');
            if (progressEl) {
                progressEl.textContent = `${current} / ${total} cards`;
            }
        }

        // Remove loading overlay
        function hideLoadingOverlay() {
            const loadingDiv = document.getElementById('pdf-loading');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // Main export function
        async function generatePDF(raffles) {
            if (raffles.length === 0) {
                alert('No raffle items to export.');
                return;
            }

            const loadingDiv = showLoadingOverlay(raffles.length);

            try {
                await loadPDFLibraries();

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'pt',
                    format: 'letter'
                });

                const templateImg = await loadTemplateImage();
                const qrImg = await loadQRCodeImage();

                // 2x2 grid positions
                const positions = [
                    { x: 0, y: 0 },                                      // Top left
                    { x: PDF_CONFIG.cardWidth, y: 0 },                   // Top right
                    { x: 0, y: PDF_CONFIG.cardHeight },                  // Bottom left
                    { x: PDF_CONFIG.cardWidth, y: PDF_CONFIG.cardHeight } // Bottom right
                ];

                // Process raffles in groups of 4 (one page)
                const totalPages = Math.ceil(raffles.length / 4);

                for (let pageIndex = 0; pageIndex < totalPages; pageIndex++) {
                    if (pageIndex > 0) {
                        pdf.addPage();
                    }

                    const pageRaffles = raffles.slice(pageIndex * 4, (pageIndex + 1) * 4);

                    for (let i = 0; i < pageRaffles.length; i++) {
                        const raffle = pageRaffles[i];
                        const pos = positions[i];

                        // Create card canvas
                        const cardCanvas = await createCardCanvas(raffle, templateImg, qrImg);
                        const cardDataUrl = cardCanvas.toDataURL('image/png');

                        // Add to PDF
                        pdf.addImage(
                            cardDataUrl,
                            'PNG',
                            pos.x,
                            pos.y,
                            PDF_CONFIG.cardWidth,
                            PDF_CONFIG.cardHeight
                        );

                        // Update progress
                        const processed = pageIndex * 4 + i + 1;
                        updateLoadingProgress(processed, raffles.length);
                    }
                }

                // Generate filename with date
                const date = new Date().toISOString().split('T')[0];
                const filename = `C4C_Raffle_Cards_${date}.pdf`;

                pdf.save(filename);

            } catch (error) {
                console.error('PDF generation failed:', error);
                alert('Failed to generate PDF: ' + error.message);
            } finally {
                hideLoadingOverlay();
            }
        }

        // Export all raffles
        async function exportAllToPDF() {
            await generatePDF(allAdminRaffles);
        }

        // Export selected raffles
        async function exportSelectedToPDF() {
            const selectedIds = getSelectedRaffleIds();
            if (selectedIds.length === 0) {
                alert('Please select at least one raffle item to export.');
                return;
            }
            const selectedRaffles = allAdminRaffles.filter(r => selectedIds.includes(r.id));
            await generatePDF(selectedRaffles);
        }

        // Selection helpers
        function getSelectedRaffleIds() {
            const checkboxes = document.querySelectorAll('.raffle-select:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.dataset.raffleId));
        }

        function updateExportButton() {
            const selectedCount = getSelectedRaffleIds().length;
            const btn = document.getElementById('export-selected-btn');
            btn.disabled = selectedCount === 0;
            btn.textContent = `Export Selected (${selectedCount})`;

            // Update header checkbox state
            const allCheckboxes = document.querySelectorAll('.raffle-select');
            const headerCheckbox = document.getElementById('header-select-all');
            if (headerCheckbox && allCheckboxes.length > 0) {
                headerCheckbox.checked = selectedCount === allCheckboxes.length;
                headerCheckbox.indeterminate = selectedCount > 0 && selectedCount < allCheckboxes.length;
            }
        }

        function toggleSelectAll() {
            const headerCheckbox = document.getElementById('header-select-all');
            const checkboxes = document.querySelectorAll('.raffle-select');
            checkboxes.forEach(cb => cb.checked = headerCheckbox.checked);
            updateExportButton();
        }
    </script>
</body>
</html>
